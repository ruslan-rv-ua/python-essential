# Простори імен. Області видимості.

<!--
Спочатку трошки теорії:

> **Простір імен**, також *про́стір назв* або *іменний про́стір* (англ. namespace) — концепція у програмуванні, призначена для розмежування різних множин ідентифікаторів і попередження конфліктів між їхніми іменам

> **Область видимості** або **межі дії** (англ. scope) — це ділянка програми, де існує окрема множина імен, пов'язаних із певними даними (змінними) чи оголошеннями (функціями, класами тощо). Однакові імена можуть вживатися на різних ділянках програми (а отже мати різні межі дії), але мати різне значення (посилатися на різні дані) чи стосуватися різних оголошень.

Імена в Python також мають області видимості. 
В залежності від місця у коді, де ім'я було визначене, визначається і область видимості, тобто, де це ім'я  буде доступним.

При використанні імен змінних у програмі, Python кожного разу шукає, створює або змінює ці імена у відповідному просторі імен. 
Простір імен, який є доступним в кожен момент, залежить від області, в якій знаходиться код.

## Вкладені функції

Коли ми оголошуємо функцію, в її тілі ми можемо використовувати будь-які оператори, у тому числі і оголошення функції. 

	:::python
	>>> def outer(arg):
	...     def inner(x):
	...             return x*x
	...     if arg > 0:
	...             return inner(arg)
	...
	>>>
	>>> outer(10)
	100
	>>> inner(10)
	Traceback (most recent call last):
	  File "<stdin>", line 1, in <module>
	NameError: name 'inner' is not defined
	>>>
	
Функція `inner()` є локальною по відношенню до функції `outer()`. Тому до внутрішньої функції, як і до будь-якого локальлного об'єкта, ми не можемо отримати доступу ззовні.

## LEGB

В Python існує 4 області видимості:

* Local — локальна (всередині функції)
* Enclosing — локальна область функцій-обгорток, які у свою чергу містять інші функції
* Global — глобальна (модуль)
* Built-in — вбудована (зарезервовані значення Python)

В Python є правило LEGB, яким він користується при пошуці змінних. 
Якщо  всередині функції виконується звернення до змінної, Python шукає її ім'я по областям видимості у такому порядку (до першого співпадіння):

	Local — Enclosing — Global — Built-in
	
### Local

Цю область видимості мають змінні, котрі ініціалізуються всередині функцій.

    :::python
    >>> def add_two(a):
            x = 2
            return a + x

    >>> add_two(3)
    5

    >>> print(x)
    Traceback (most recent call last):
      File "<pyshell#5>", line 1, in <module>
        print(x)
    NameError: name 'x' is not defined

У наведеному прикладі оголошена функція `add_two()`, 
яка додає двійку до  переданого їй числа і повертає отриманий результат. 
Всередині цієї функції  використовується змінна `x`, доступ до якої ззовні неможливий.

Кожного разу, коли ми викликаємо функцію, у неї створюються локальні змінні (якщо вони у неї є), а після завершення — знищуються. 
При черговому виклику функції ця процедура повторюється.





### Enclosing

Суть даної області видимості полягає у том, що всередині функції можуть бути вкладені функції і локальні змінні. 
Локальна змінна функції для її вкладеної функції знаходиться в области видимости `enclosing`.

    :::python
    >>> def outer():
    ...     x = "x modified inside outer"
    ...     def inner():
    ...         print("inner():", x)
    ...     inner()
    ...     print("outer():", x)
    ...
    >>> outer()
    inner(): x modified inside outer
    outer(): x modified inside outer
    >>>
    
У наведеному прикладі змінна `x` має область видимості `enclosing` для функції `inner()`.

#### Інструкція `nonlocal`

    :::python
    >>> def outer():
    ...     x = "x modified inside outer"
    ...     def inner():
    ...         x = "x modified inside inner"
    ...         print("inner():", x)
    ...     inner()
    ...     print("outer():", x)
    ...
    >>> outer()
    inner(): x modified inside inner
    outer(): x modified inside outer
    >>>    

Функції `outer()` та `inner()` кожна мають свої локальні змінні `x`.

Всередині вкладеної функції ми маємо можливість вказати, що певна змінна не є локальною для цієї вкладеної функції, а є локальною для функції-обгортки. 
Робиться це за допомогою інструкції `nonlocal`:

    :::python
    >>> def outer():
    ...     x = "x modified inside outer"
    ...     def inner():
    ...         nonlocal x
    ...         x = "x modified inside inner"
    ...         print("inner():", x)
    ...     inner()
    ...     print("outer():", x)
    ...
    >>> outer()
    inner(): x modified inside inner
    outer(): x modified inside inner
    >>>
    
Всередині функції `inner()` ми вказали, що змінна `x` є локальною для функції `outer()`. 
Тобто змінна `x` як би попадає з функції `outer()` в простір імен функції `inner()`. 
Якщо ми змінемо значення нелокальної змінної, це відобразиться і на локальній змінній. 

`nonlocal` обмежує пошук областями видимості функцій-обгорток. 
Вона вимагає, щоб перераховані імена вже існували та дозволяє просвоювати їм нові значення. 
В область пошуку не входять глобальна і вбудована області видимості.

### Global

Змінні області видимості `global` — це глобальні змінні рівня модуля (тобто `.py`-файла).

    :::python
    >>> x = 4
    >>> def fun():
            print(x+3)

    >>> fun()
    7

#### Інструкція `global`

Існує можливість змінити значення глобальної змінної за допомогою інструкції 'global':

    :::python
    >>> x = 'global'
    >>> def f():
    ...     global x
    ...     x = 'global modified in function'
    ...     print (x)
    ...
    >>> f()
    global modified in function
    >>>

`global` змушує інтерпретатор починати пошук імен з області модуля і  дозволяє присвоювати змінним нові значення. 
Область пошуку простирається аж до області видимости Built-in якщо потрібне ім'я не буде знайдено у модулі, 
при цьому операція присвоєння значень глобальним іменам завжди буде створювати або змінювати змінні в області видимості модуля.

### Built-in

Рівень інтерпретатора Python. 

В межах цієї області видимості знаходяться функції `len()`, `print()` і т.ін. 
Ці сутності знаходиться у модулі `__builtins__` і завжди доступні у будь-якому модулі Python. 
Вміст цього модуля імпортується автоматично, отже вам не треба попередньо нічого імпортувати.

`Built-in` — це максимально широка область видимості.

## Резюме

* В Python існує чотирио бласті видимості: вбудована, глобальна, обгортаюча і локальна.
* Правило LEGB: пошук імен відбувається від локальної до вбудованої.
* При використанні і операції присвоєння ім'я вважається локальним. Цю поведінку можна змінити за допомогою операторів `global` та `nonlocal`.

## Додаткові матеріали

* [Вікіпедія: Область видимості](https://uk.wikipedia.org/wiki/%D0%9E%D0%B1%D0%BB%D0%B0%D1%81%D1%82%D1%8C_%D0%B2%D0%B8%D0%B4%D0%B8%D0%BC%D0%BE%D1%81%D1%82%D1%96_(%D0%BF%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D1%83%D0%B2%D0%B0%D0%BD%D0%BD%D1%8F))

-->